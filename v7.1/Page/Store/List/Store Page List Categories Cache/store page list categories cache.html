<!-- begin TWC Store Page List Categories Cache -->

  <script>
  
    ( async ( ) => {
    
      /*
      
        store page list categories cache
        
        License       : < https://tinyurl.com/s872fb68 >
        
        Version       : 0.4.1
        
        SS Version    : 7.1
        
        Products V2
        Compatible    : Yes
        
        Fluid
        Engine
        Compatible    : Not Applicable
        
        Notes         : the code is comprised of two script tags. both are
                        needed for the full effect to work
                        
                        the code makes a call to the json version of the store
                        page for information that is not normally available
        
        Copyright     : 2023-2025 Thomas Creedon
                        
                        Tom's Web Consulting < http://www.tomsWeb.consulting/ >
        
        no user serviceable parts below
        
        */
        
      const
      
        version = '0.4.1',
        
        s = `
        
          Store Page List Categories Cache v${ version }
          
          License < https://tinyurl.com/s872fb68 >
          
          Â© 2023-2025 Thomas Creedon
          
          Tom's Web Consulting < http://www.tomsWeb.consulting >
          
          `
          
          .replace ( /^\s+/gm, '' );
          
      console.log ( s );
      
      const isStorePage = Static
      
        .SQUARESPACE_CONTEXT
        
        .collection
        
        ?.type
        
        ===
        
        13;
        
      if ( ! isStorePage ) return; // bail if not store page
      
      const isList
      
        =
        
        !
        
        Static
        
          .SQUARESPACE_CONTEXT
          
          .item
          
          ?.id;
          
      if ( ! isList ) return; // bail if not list page
      
      const isTag = ( ( ) => {
      
        const
        
          p = new URLSearchParams ( location.search )
          
          is = p.has ( 'tag' );
          
        return is;
        
        } ) ( );
        
      if ( isTag ) return; // bail if tag page
      
      const
      
        codeKey = 'twc-splcc',
        
        options = codeKey
        
          .split ( '-' )
          
          .reduce ( ( obj, key ) => obj?.[ key ], window ),
          
        hasCallbacks = options
        
          .callbacks
          
          .length;
          
      // bail if no callbacks
      
      if ( ! hasCallbacks ) {
      
        const s = `${ codeKey } no callbacks`;
        
        console.warn ( s );
        
        return;
        
        }
        
      const userCallbacks = ( categories ) => {
      
        const callback = ( callback ) => {
        
          try {
          
            callback ( categories );
            
            } catch ( error ) {
            
              const s = `${ codeKey } callback error`;
              
              console.error ( s, error );
              
              }
              
          };
        
        options
        
          .callbacks
          
          .forEach ( callback );
          
        };
        
      let categories = sessionStorage
      
        .getItem ( codeKey );
        
      // bail if categories
      
      if ( categories ) {
      
        categories = JSON.parse ( categories );
        
        userCallbacks ( categories );
        
        return;
        
        }
        
      const
      
        traverse = ( categories ) => {
        
          const callback = ( category, i ) => {
          
            const callback = ( key ) => {
            
              const is = keepKeys.includes ( key );
              
              if ( is ) return true; // continue
              
              delete category [ key ];
              
              };
              
            Object
            
              .keys ( category )
              
              .forEach ( callback );
              
            traverse ( category.children );
            
            };
            
          categories.forEach ( callback );
          
          },
          
        unique = ( value, index, array ) => {
        
          const b = array.indexOf ( value ) === index;
          
          return b;
          
          },
          
        url = `${
        
          Static
          
            .SQUARESPACE_CONTEXT
            
            .collection
            
            .fullUrl
            
          }?format=json`;
          
      let
      
        keepKeys,
        
        nestedCategories;
        
      // keep keys
      
      {
      
        keepKeys = options.keepKeys;
        
        keepKeys.push ( 'children' );
        
        keepKeys = keepKeys.filter ( unique );
        
        }
        
      try {
      
        const response = await fetch ( url );
        
        if ( ! response.ok ) {
        
          const s = `
          
            ${ codeKey } network response was not ok ${
            
              response
              
                .statusText
                
                }
                
            `
            
            .trim ( )
            
            .replace ( /\s+/gm, ' ' );
            
          throw new Error ( s );
          
          }
          
        nestedCategories = await response.json ( );
        
        nestedCategories = nestedCategories.nestedCategories;
        
        console.log ( nestedCategories );
        
        } catch ( error ) {
        
          const s = `
          
            ${ codeKey } there has been a problem with your fetch get operation,
            
            ${ error }.
            
            `
            
            .trim ( )
            
            .replace ( /\s+/gm, ' ' );
            
          console.error ( s );
          
          } finally {
          
            categories = nestedCategories.all;
            
            if ( categories ) {
            
              categories.children = nestedCategories.categories;
              
              categories = [ categories ];
              
              } else
              
                categories = nestedCategories.categories;
                
            traverse ( categories );
            
            sessionStorage.setItem (
            
              codeKey,
              
              JSON
              
                .stringify ( categories )
                
              );
              
            userCallbacks ( categories );
            
            }
            
      } ) ( );
      
    </script>
    
  <!-- end TWC Store Page List Categories Cache -->
