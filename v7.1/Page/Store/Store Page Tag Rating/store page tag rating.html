<!-- begin TWC Store Page Tag Rating -->

  <!--
  
    store page tag rating
    
    License       : < https://tinyurl.com/s872fb68 >
    
    Version       : 0.4.0
    
    SS Version    : 7.1
    
    Products V2
    Compatible    : Yes
    
    Fluid
    Engine
    Compatible    : Not Applicable
    
    Notes         : the code is comprised of several tags. all are needed for
                    the full effect to work
                    
                    this is not an site visitor rating system
                    
                    the code makes a call to the json version of the store page
                    to grab the tags as entered in the UI
    
    Copyright     : 2023-2025 Thomas Creedon
                    
                    Tom's Web Consulting < http://www.tomsWeb.consulting/ >
    
    no user serviceable parts below
    
    -->
    
    <style>
    
      .product-list .product-list-item .product-list-item-link .product-list-item-meta .twc-sptr {
      
        margin-top : var( --twc-sptr-list-margin-top );
        
        }
        
      .product-detail .product-meta .twc-sptr {
      
        margin-right : auto;
        
        }
        
      .product-detail .product-meta .twc-sptr {
      
        order : 4;
        
        }
        
      .twc-sptr .rating {
      
        vertical-align : top;
        
        }
        
      .twc-sptr .label {
      
        padding-left : 0.5em;
        
        }
        
      .twc-sptr .overlay {
      
        bottom : 0;
        left : 0;
        position : absolute;
        right : 0;
        top : 0;
        
        }
        
      .twc-sptr .points {
      
        text-align : right;
        
        }
        
      .twc-sptr .point:not( .scale ),
      .twc-sptr .words
      
        {
        
          font-weight : bold;
          
          }
          
      .twc-sptr .point.scale {
      
        display : var( --twc-sptr-scale-display );
        
        }
        
      .twc-sptr .point.scale::before {
      
        content : '/';
        font-weight : normal;
        
        }
        
      .twc-sptr .symbol {
  
        display : inline-block;
        position : relative;
        
        }
        
      .twc-sptr .symbol.false {
  
        display : var( --twc-sptr-symbols-false-display );
        
        }
        
      .twc-sptr .symbols {
      
        text-align : right;
        white-space : nowrap;
        
        }
        
      </style>
      
    <script>
    
      ( ( ) => {
      
        const callback = async ( ) => {
        
          const
          
            version = '0.4.0',
          
            s = `
            
              Store Page Tag Rating v${ version }
              
              License < https://tinyurl.com/s872fb68 >
              
              Â© 2023-2025 Thomas Creedon
              
              Tom's Web Consulting < http://www.tomsWeb.consulting >
              
              `
              
              .replace ( /^\s+/gm, '' );
              
          console.log ( s );
          
          const isStorePage = Static
          
            .SQUARESPACE_CONTEXT
            
            .collection
            
            .type
            
            ===
            
            13;
            
          if ( ! isStorePage ) return; // bail if not store page
          
          // globals
          
          {
          
            // initialize twc module
            
            window.twc = ( ( self ) => self ) ( window.twc || { } );
            
            // initialize twc sptr sub-module
            
            twc.sptr = ( ( self ) => self ) ( twc.sptr || { } );
            
            }
            
          const
          
            callback = ( tag ) => {
            
              const
              
                re
                
                  =
                  
                  new RegExp ( `${ codeKey } (.+) ([spw]) (.+)` ),
                  
                data = tag
                
                  .match ( re );
                  
              if ( ! data ) return true; // continue if tag doesn't match format
              
              tag = tag
              
                .toLowerCase ( )
                
                .replaceAll ( ' ', '-' )
                
                .replace ( /[^\w-]+/g, '' )
                
                .replaceAll ( '--', '-' );
                
              const
              
                callback = ( element ) => {
                
                  const
                  
                    classList = element
                    
                      .classList,
                      
                    isDetailClass = classList
                    
                      .contains ( 'product-detail' ),
                      
                    isListItem = classList
                    
                      .contains ( 'product-list-item' );
                      
                  let
                  
                    html,
                    
                    ratingElement = document
                    
                      .createElement ( 'template' ),
                      
                    selector;
                    
                  // rating element
                  
                  {
                  
                    ratingElement
                    
                      .innerHTML
                      
                      =
                      
                      `
                      
                        <tr class="rating">
                        
                          <td class="points symbols words">
                          
                            </td>
                            
                          <td class="label">
                          
                            </td>
                            
                          </tr>
                          
                        `
                        
                        .trim ( );
                        
                    ratingElement = ratingElement
                    
                      .content
                      
                      .firstElementChild;
                      
                    }
                    
                  switch ( true ) {
                  
                    case isDetailClass : {
                    
                      const isLayoutFull = document
                      
                        .body
                        
                        .querySelector (
                        
                          '[ data-product-detail-layout="full" ]'
                          
                          );
                          
                      if ( ! isLayoutFull )
                      
                        selector = '.product-detail .product-meta';
                        
                        else
                        
                          selector
                          
                            =
                            
                            '.product-detail '
                            
                            +
                            
                            '[ data-product-detail-layout="full" ] '
                            
                            +
                            
                            '.product-meta-section:last-child';
                            
                      break;
                      
                      }
                      
                    case isListItem :
                    
                      selector = '.product-list-item-meta';
                      
                      break;
                      
                    }
                    
                  const wrapperElement = element
                  
                    .querySelector ( selector );
                    
                  let sptrElement = wrapperElement
                  
                    .querySelector ( `.${ codeKey }` );
                    
                  if ( ! sptrElement ) {
                  
                    wrapperElement
                    
                      .insertAdjacentHTML (
                      
                        'beforeend',
                        
                        `
                        
                          <table class="twc-sptr">
                          
                            <tbody>
                            
                              </tbody>
                              
                            </table>
                            
                          `
                          
                        );
                        
                    sptrElement = wrapperElement
                    
                      .querySelector ( `.${ codeKey }` );
                      
                    }
                    
                  ratingElement
                  
                    .querySelector ( '.label' )
                    
                    .textContent
                    
                    =
                    
                    label;
                    
                  switch ( type ) {
                  
                    case 'p' : {
                    
                      const tdElement = ratingElement
                      
                        .querySelector ( '.points' );
                        
                      tdElement
                      
                        .classList
                        
                        .remove ( 'symbols', 'words' );
                        
                      tdElement
                      
                        .insertAdjacentHTML (
                        
                          'beforeend',
                          
                          `
                          
                            <span class="point">
                            
                              ${ points }
                              
                              </span>
                              
                            <span class="point scale">
                            
                              ${ scale }
                              
                              </span>
                              
                            `
                            
                          );
                          
                      break;
                      
                      }
                      
                    case 's' : {
                    
                      const tdElement = ratingElement
                      
                        .querySelector ( '.symbols' );
                        
                      let
                      
                        i,
                        
                        textNode;
                        
                      html = `
                      
                        <span class="false symbol true">
                        
                          <span class="overlay">
                          
                            </span>
                            
                          </span>
                          
                        `;
                        
                      tdElement
                      
                        .classList
                        
                        .remove ( 'points', 'words' );
                        
                      // true symbols
                      
                      {
                      
                        for ( i = 0; i < points; i++ ) {
                        
                          let spanElement = document
                          
                            .createElement ( 'template' );
                            
                          textNode = document
                          
                            .createTextNode (
                            
                              options
                              
                                .trueSymbol
                                
                              );
                              
                          // span element
                          
                          {
                          
                            spanElement
                            
                              .innerHTML
                              
                              =
                              
                              html;
                              
                            spanElement = spanElement
                            
                              .content
                              
                              .firstElementChild;
                              
                            spanElement
                            
                              .classList
                              
                              .remove ( 'false' );
                              
                            spanElement
                            
                              .prepend ( textNode );
                              
                            }
                            
                          tdElement
                          
                            .append ( spanElement );
                            
                          }
                          
                        if ( i !== points ) {
                        
                          const
                          
                            width = points % 1 * 100,
                            
                            value
                            
                              =
                              
                              'linear-gradient( to right, transparent '
                              
                              +
                              
                              `${ width }%, var( --siteBackgroundColor ) `
                              
                              +
                              
                              `${ width }% )`;
                              
                          [
                          
                            ...
                            
                            document
                            
                              .body
                              
                              .querySelectorAll ( '.symbol' )
                              
                            ]
                            
                            .slice ( -1 )
                            
                            [ 0 ]
                          
                            .querySelector ( '.overlay' )
                            
                            .style
                            
                            .setProperty ( 'background', value );
                            
                          }
                          
                        }
                        
                      // false symbols
                      
                      {
                      
                        points = scale - i;
                        
                        for ( let i = 0; i < points; i++ ) {
                        
                          let spanElement = document
                          
                            .createElement ( 'template' );
                            
                          textNode = document
                          
                            .createTextNode (
                            
                              options
                              
                                .falseSymbol
                                
                              );
                              
                          // span element
                          
                          {
                          
                            spanElement
                            
                              .innerHTML
                              
                              =
                              
                              html;
                              
                            spanElement = spanElement
                            
                              .content
                              
                              .firstElementChild;
                              
                            spanElement
                            
                              .classList
                              
                              .remove ( 'true' );
                              
                            spanElement
                            
                              .prepend ( textNode );
                              
                            }
                            
                          tdElement
                          
                            .append ( spanElement );
                            
                          }
                          
                        }
                        
                      selector = '.overlay:not( [ style ] )';
                      
                      tdElement
                      
                        .querySelector ( selector )
                        
                        .remove ( );
                        
                      break;
                      
                      }
                      
                    case 'w' : {
                    
                      const tdElement = ratingElement
                      
                        .querySelector ( '.words' );
                      
                      tdElement
                      
                        .classList
                      
                        .remove ( 'points', 'symbols' );
                        
                      tdElement
                      
                        .insertAdjacentHTML (
                        
                          'beforeend',
                          
                          `
                          
                            <span>
                            
                              ${ rating }
                              
                              </span>
                              
                            `
                            
                          );
                          
                      break;
                      
                      }
                      
                    }
                    
                  sptrElement
                  
                    .querySelector ( 'tbody' )
                    
                    .append ( ratingElement );
                    
                  },
                  
                label = data [ 1 ],
                
                rating = data [ 3 ],
                
                suffix = `.tag-${ tag }`,
                
                type = data [ 2 ],
                
                isPointsScale = [ 
                
                  'p',
                  
                  's'
                  
                  ]
                  
                  .includes ( type ),
                  
                selector = [
                
                  '.product-list .product-list-item',
                  
                  '.product-detail'
                  
                  ]
                  
                  .join ( `${ suffix }, ` )
                  
                  +
                  
                  suffix;
                  
              let
              
                points,
                
                scale;
                
              if ( isPointsScale ) { // points and scale
              
                points = rating.split ( '/' );
                
                scale = Number ( points [ 1 ] );
                
                points = Number ( points [ 0 ] );
                
                }
                
              document
              
                .body
                
                .querySelectorAll ( selector )
                
                .forEach ( callback );
                
              },
              
            codeKey = 'twc-sptr',
            
            options = codeKey
            
              .split ( '-' )
              
              .reduce ( ( obj, key ) => obj?.[ key ], window ),
              
            url = Static
            
              .SQUARESPACE_CONTEXT
              
              .collection
              
              .fullUrl
              
              +
              
              '?format=json';
              
          try {
          
            const response = await fetch ( url );
            
            if ( ! response.ok ) {
            
              const s = `
              
                ${ codeKey } network response was not ok ${
                
                  response
                  
                    .statusText
                    
                    }
                    
                `
                
                .trim ( )
                
                .replace ( /\s+/gm, ' ' );
                
              throw new Error ( s );
              
              }
              
            const obj = await response.json ( );
            
            obj
            
              .collection
              
              .tags
              
              .filter ( t => t.startsWith ( `${ codeKey } ` ) )
              
              .sort ( )
              
              .forEach ( callback );
              
            } catch ( error ) {
            
              const s = `
              
                ${ codeKey } there has been a problem with your fetch get operation,
                
                ${ error }.
                
                `
                
                .trim ( )
                
                .replace ( /\s+/gm, ' ' );
                
              console.error ( s );
              
              }
              
          };
          
        document
        
          .addEventListener ( 'DOMContentLoaded', callback );
          
        } ) ( );
        
      </script>
      
  <!-- end TWC Store Page Tag Rating -->
